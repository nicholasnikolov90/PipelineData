import pandas as pd
import numpy as np

#reads the data as a .csv file. 
#Copy the entire code stress results grid, this function will clean up the columns automatically
#input the csv file here. Ensure the python script file and the csv file are in the same folder.
df = pd.read_csv('12329.csv', low_memory=False)
dfg = pd.read_csv('12329g.csv', low_memory=False)

#deletes the unused columns and second row that sounds units. 
#If any of these columns are needed just delete from this array
dfg = dfg.tail(-1)
df = df.tail(-1)
df = df.drop(columns=["Internal1", "Internal2", "PointOrder", 'CombinationOrder', 'PlusSideOrder', 'PercSoilOrder', 'CategoryOrder', 'Equation', 'SIF-In', 'SIF-Out', 'SectMod1', 'Torsion', 'Moment-In', 'Moment-Out', 'AxialForce', 'AxialStress', 'Bending', 'ShearStress', 'Pressure', 'Bending'])

#Data clean up
#Removes all duplicates based on soil points#
points = df['Point'].str.split(' ').str[0]
points = points.str.split('N').str[0]
points = points.str.split('F').str[0]
points = points.str.split('M').str[0]
pointsg = dfg['Point'].str.split(' ').str[0]
pointsg = pointsg.str.split('N').str[0]
pointsg = pointsg.str.split('F').str[0]
pointsg = pointsg.str.split('M').str[0]
dfg['Point'] = pointsg
df['Point'] = points
dfg['Total Stress'] = dfg['Total Stress'].astype(float)
#Manually calculate ratio to get more significant digits

df['Ratio'] = (df['Stress'].astype(float) / df['Allowable'].astype(float))*100
df['Ratio'] = df['Ratio'].round(2)


#Remove all duplicates from the general stress, sort all points by max total stress
df_new = dfg.sort_values('Total Stress', ascending=False).drop_duplicates('Point').sort_index()

#Get general stress in terms of a ratio
allowables = df.sort_values('Allowable', ascending=False).drop_duplicates('Point').sort_index()

#Get general stress in terms of a ratio
merged = pd.merge(allowables, df_new, on="Point")
merged['General'] = (merged['Total Stress'].astype(float) / merged['Allowable'].astype(float))*100
merged['General'] = merged['General'].round(2)
gsonly = merged[['Point', 'General']]

#Creates the main results table using a pivot table. 
#"points" are a list of all nodes after cleaning up soil points. Contains many duplicates
#points must be the same size as the data, don't delete non-duplicate nodes
#values= are the stress ratios 'Ratio'
#columns are each nodes
#Index are the rows - stress categories (Expansion, Tresca etc..)
#aggfunc=np.max makes sure to take the maximum at each indexm (node)

#reverse columns and index if need to change columns and rows
table = pd.pivot_table(df, values='Ratio',index=points, columns='Category', aggfunc=np.max)

df_merged = table.merge(gsonly, on= gsonly['Point'])
df_merged = df_merged.T.drop(index = 'Point')

#Outputs results to excel
df_merged.to_excel("output.xlsx")  
